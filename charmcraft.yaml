# Copyright 2025 Canonical
# See LICENSE file for licensing details.
name: sloth-k8s
summary: Sloth SLI/SLO generator for Prometheus.
description: |
  Sloth generates Prometheus alerting and recording rules based on SLO specifications.
  Helps teams maintain and monitor service reliability targets.

type: "charm"

links:
  documentation: https://discourse.charmhub.io/t/sloth-k8s-docs
  website: https://charmhub.io/sloth-k8s
  source: https://github.com/canonical/sloth-k8s-operator
  issues: https://github.com/canonical/sloth-k8s-operator/issues

platforms:
  ubuntu@24.04:amd64:

parts:
  charm:
    source: .
    plugin: uv
    build-packages: [git]
    build-snaps: [astral-uv]
    override-build: |
      craftctl default
      git describe --always > $CRAFT_PART_INSTALL/version

assumes:
  - juju >= 3.6

containers:
  sloth:
    resource: sloth-image
  nginx:
    resource: nginx-image
  nginx-prometheus-exporter:
    resource: nginx-prometheus-exporter-image


resources:
  sloth-image:
    type: oci-image
    description: OCI image for sloth
    # Included for simplicity in integration tests
    upstream-source: ghcr.io/slok/sloth:v0.11.0
  nginx-image:
    type: oci-image
    description: OCI image for nginx
    upstream-source: ubuntu/nginx:1.24-24.04_beta
  nginx-prometheus-exporter-image:
    type: oci-image
    description: OCI image for nginx-prometheus-exporter
    upstream-source: nginx/nginx-prometheus-exporter:1.1.0

requires:
  catalogue:
    optional: true
    interface: catalogue
    description: Display sloth entry in the COS catalogue frontend.
  ingress:
    optional: true
    interface: traefik_route
    limit: 1
    description: |
      Ingress integration for the Sloth server.
  charm-tracing:
    optional: true
    description: |
      Enables sending charm traces to a distributed tracing backend such as Tempo.
    limit: 1
    interface: tracing
  certificates:
    optional: true
    interface: tls-certificates
    limit: 1
    description: |
      Certificate and key files for securing Sloth's external
      communications through TLS.
  logging:
    optional: true
    interface: loki_push_api
    description: |
        Enables sending workload logs to a loki-push-api compatible endpoint.
  slos:
    optional: true
    interface: slo
    description: |
      Receives SLO (Service Level Objective) specifications from related charms.
      Sloth will convert these specifications into Prometheus recording and alerting rules.

provides:
  grafana-dashboard:
    optional: true
    interface: grafana_dashboard
    description: |
      This integration provisions a grafana dashboard to monitor this charm.
  metrics-endpoint:
    optional: true
    interface: prometheus_scrape
    description: |
      Endpoint to allow prometheus metrics to be scraped from this sloth instance.

peers:
  sloth-peers:
    interface: sloth_peers

actions:
  list-endpoints:
    description: | 
      Return the endpoints that the sloth server is listening on.
      Will list both direct and ingressed hosts.

config:
  options:
    slo-period:
      description: |
        The period for SLO calculations (e.g., "30d" for 30 days).
      type: string
      default: "30d"
