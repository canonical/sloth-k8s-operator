# Copyright 2025 Canonical
# See LICENSE file for licensing details.
name: sloth-k8s
summary: Sloth SLI/SLO generator for Prometheus.
description: |
  Sloth generates Prometheus alerting and recording rules based on SLO specifications.
  Helps teams maintain and monitor service reliability targets.

type: "charm"

links:
  documentation: https://discourse.charmhub.io/t/sloth-k8s-docs
  website: https://charmhub.io/sloth-k8s
  source: https://github.com/canonical/sloth-k8s-operator
  issues: https://github.com/canonical/sloth-k8s-operator/issues

assumes:
  - juju >= 3.6

platforms:
  ubuntu@24.04:amd64:

parts:
  charm:
    source: .
    plugin: uv
    build-packages: [git]
    build-snaps: [astral-uv]
    override-build: |
      craftctl default
      git describe --always > $CRAFT_PART_INSTALL/version

containers:
  sloth:
    resource: sloth-image

resources:
  sloth-image:
    type: oci-image
    description: OCI image for sloth
    upstream-source: ubuntu/sloth@0.15-24.04  # renovate: oci-image tag: 0.15-24.04

requires:
  catalogue:
    interface: catalogue
    optional: true
    description: |
      Enables registration with the Catalogue for service discovery.
  charm-tracing:
    optional: true
    description: |
      Enables sending charm traces to a distributed tracing backend such as Tempo.
    limit: 1
    interface: tracing
  ingress:
    interface: ingress
    optional: true
    limit: 1
    description: |
      Enables ingress for external access to the Sloth UI.
  receive-ca-cert:
    interface: certificate_transfer
    optional: true
    description: |
      Receive a CA cert for grafana to trust.
      This relation can be used with a local CA to obtain the CA cert that was used to sign proxied
      endpoints.
  logging:
    optional: true
    interface: loki_push_api
    description: |
        Enables sending workload logs to a loki-push-api compatible endpoint.
  sloth:
    optional: true
    interface: sloth
    description: |
      Receives SLO (Service Level Objective) specifications from related charms.
      Sloth will convert these specifications into Prometheus recording and alerting rules.

provides:
  grafana-dashboard:
    optional: true
    interface: grafana_dashboard
    description: |
      This integration provisions a grafana dashboard to monitor this charm.
  metrics-endpoint:
    optional: true
    interface: prometheus_scrape
    description: |
      Endpoint to allow prometheus metrics to be scraped from this sloth instance.

peers:
  sloth-peers:
    interface: sloth_peers

config:
  options:
    slo-period:
      description: |
        The period for SLO calculations (e.g., "30d" for 30 days).
      type: string
      default: "30d"
