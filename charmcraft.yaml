# Copyright 2025 Canonical
# See LICENSE file for licensing details.
name: sloth-k8s
summary: Sloth SLI/SLO generator for Prometheus.
description: |
  Sloth generates Prometheus alerting and recording rules based on SLO specifications.
  Helps teams maintain and monitor service reliability targets.

type: "charm"

links:
  documentation: https://discourse.charmhub.io/t/sloth-k8s-docs
  website: https://charmhub.io/sloth-k8s
  source: https://github.com/canonical/sloth-k8s-operator
  issues: https://github.com/canonical/sloth-k8s-operator/issues

assumes:
  - juju >= 3.6

platforms:
  ubuntu@24.04:amd64:

parts:
  charm:
    source: .
    plugin: uv
    build-packages: [git]
    build-snaps: [astral-uv]
    override-build: |
      craftctl default
      git describe --always > $CRAFT_PART_INSTALL/version

containers:
  sloth:
    resource: sloth-image

resources:
  sloth-image:
    type: oci-image
    description: OCI image for sloth
    upstream-source: ubuntu/sloth@sha256:54ef899eb01a6abbf448628e5b2f1b687f7e7bb712c8bcd260cec30e85a91cb3  # renovate: oci-image tag: 0.15-24.04

requires:
  catalogue:
    interface: catalogue
    optional: true
    description: |
      Enables registration with the Catalogue for service discovery.
  charm-tracing:
    optional: true
    description: |
      Enables sending charm traces to a distributed tracing backend such as Tempo.
    limit: 1
    interface: tracing
  ingress:
    interface: ingress
    optional: true
    limit: 1
    description: |
      Enables ingress for external access to the Sloth UI.
  receive-ca-cert:
    interface: certificate_transfer
    optional: true
    description: |
      Receive a CA cert for grafana to trust.
      This relation can be used with a local CA to obtain the CA cert that was used to sign proxied
      endpoints.
  logging:
    optional: true
    interface: loki_push_api
    description: |
        Enables sending workload logs to a loki-push-api compatible endpoint.
  sloth:
    optional: true
    interface: sloth
    description: |
      Receives SLO (Service Level Objective) specifications from related charms.
      Sloth will convert these specifications into Prometheus recording and alerting rules.

provides:
  grafana-dashboard:
    optional: true
    interface: grafana_dashboard
    description: |
      This integration provisions a grafana dashboard to monitor this charm.
  metrics-endpoint:
    optional: true
    interface: prometheus_scrape
    description: |
      Endpoint to allow prometheus metrics to be scraped from this sloth instance.

peers:
  sloth-peers:
    interface: sloth_peers

config:
  options:
    slo-period:
      description: |
        The default SLO period for calculations (e.g., "30d" for 30 days, "28d" for 28 days, "7d" for 7 days).
        This is used when no custom SLO period windows configuration is provided.
        
        Sloth uses this to generate alert windows based on Google's SRE Workbook recommendations.
        The built-in windows are optimized for 30d and 28d periods.
        
        **IMPORTANT**: If you use a period other than 30d or 28d, you MUST also provide 
        slo-period-windows configuration. Otherwise, the charm will be in a blocked state.
      type: string
      default: "30d"
    slo-period-windows:
      description: |
        Custom SLO period windows configuration in YAML format.
        
        This allows you to define custom alerting windows for SLO monitoring.
        When provided, this overrides the default period windows for the slo-period.
        
        **REQUIRED**: This configuration is REQUIRED when using a slo-period other than 30d or 28d,
        as Sloth only has built-in defaults for those two periods.
        
        The YAML must follow the Sloth AlertWindows spec (apiVersion: sloth.slok.dev/v1, kind: AlertWindows).
        
        Example for a 7-day window:
          apiVersion: sloth.slok.dev/v1
          kind: AlertWindows
          spec:
            sloPeriod: 7d
            page:
              quick:
                errorBudgetPercent: 8
                shortWindow: 5m
                longWindow: 1h
              slow:
                errorBudgetPercent: 12.5
                shortWindow: 30m
                longWindow: 6h
            ticket:
              quick:
                errorBudgetPercent: 20
                shortWindow: 2h
                longWindow: 1d
              slow:
                errorBudgetPercent: 42
                shortWindow: 6h
                longWindow: 3d
        
        See https://sloth.dev/usage/slo-period-windows/ for more information.
      type: string
      default: ""
